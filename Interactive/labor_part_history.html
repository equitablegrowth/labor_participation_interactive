<!-- labor_part_history.html -->

<html>

<head>
	<title>History of Labor Participation Interactive</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js"></script>
	<style>
		@import url(https://fonts.googleapis.com/css?family=Lato:400,700);
		body {margin-top:50px;margin-left:50px;font-family: 'Lato'; font-weight:300; line-height:140%; padding-bottom: 100px;}

		.graph1{max-width:745px}
		.hed{font-family:'Lato';font-size:22px;font-weight:700;}
		.dek{font-family:'Lato';font-size:17px;margin-bottom:20px;}
		.note{font-family:'Lato';font-size:11px;margin-top:20px;line-height:1.1;}	
	</style>

</head>

<body>

	<div class='graph1'>
		<div class='hed'>An interactive look at participation in the labor force by age</div>
		<div class='dek'>Click an area on the chart to isolate that category. Slide along the GDP growth graph under the chart to look at a different time period.</div>
		<svg id="graph1" viewbox='0,-85,745,865' ></svg>
		<div class='note'>Note: This chart is updated monthly. Data is from the Census Bureau's Current Population Survey. Basic monthly data are used and all months are averaged together for each year. The survey was revised in 1989 and 1994; changes to both question wording and survey weights result in discontinuities in these years that may not be attributable to real changes in the economy. Notably, it was not possible to select 'retired' before 1989. GDP data is: US. Bureau of Economic Analysis, Gross Domestic Product [GDP], retrieved from FRED, Federal Reserve Bank of St. Louis https://research.stlouisfed.org/fred2/series/GDP.</div>
	</div>

</body>

<script defer>
var g1 = Snap('#graph1')
var display='years'
var color_scale=['#67c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494','#b3b3b3']
var gmin=5
var gmax=13
var gclicked=0
var gplaying=0
var lockout=0

loadmain('main.csv',function(main){
	max_year=main[0][1]
	min_year=1976
	startmonth=main[0][2]
	endmonth=main[0][3]
	for(var i=0;i<main.length;i++){
		if(main[i][1]>max_year){max_year=main[i][1]}
	}
	current_slide_year=max_year

	redraw_g1(current_slide_year,1,5,13)
	base_g1()
	basekey_g1()
	year_slider()
	
})

var showmetext=g1.text(84,-74,'WHAT IS THIS?').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'text-before-edge','font-size':'14px',fill:'#999'})
var showmerect=g1.rect(80,-75,105,20,3,3).attr({'stroke':'#cccccc','stroke-width':'1px',fill:'white','fill-opacity':0,cursor:'pointer'})
showmerect.click(graph_intro)


function graph_intro(){
	if(lockout==0){
		lockout=1
		var cover=g1.rect(5,-85,1000,1000).attr({fill:'#cccccc',opacity:.5})
		var cwindow=g1.rect(500,200,100,100).attr({fill:'black'})
		cover.attr({clip:cwindow})

	}


	// function redraw_g1(year,newdraw,min,max){
}

function base_g1(){
	// draw the axes and labels for graph 1
	// ticks on the x-axis and y-axis dotted lines
	ages=[15,30,45,60,75]
	g1.selectAll('[id="base"]').remove()

	for(var i=0;i<ages.length;i++){
		var tick=g1.line(80+(i*163.5),620,80+(i*163.5),626).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base'})
		var ticktext=g1.text(80+(i*163.5),629,ages[i]).attr({'font-family':'Lato','text-anchor':'middle','dominant-baseline':'text-before-edge','font-size':'17px',id:'base'})
	}

	// var axislabel=g1.text(80+(2*163.5),655,'Age').attr({'font-family':'Lato','text-anchor':'middle','dominant-baseline':'text-before-edge','font-size':'18px','font-weight':700})
	var ticktext=g1.text(70+(0*163.5),645,'years old').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'text-before-edge','font-size':'17px',id:'base'})
	var ticktext=g1.text(90+(4*163.5),645,'years old').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'text-before-edge','font-size':'17px',id:'base'})

	// x grid lines and labels on the y-axis
	var xaxis=g1.line(70,620,734.5,620).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',id2:'line'})
	var x20=g1.line(70,500,734,500).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',opacity:.2,id2:'line'})
	var x40=g1.line(70,380,734,380).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',opacity:.2,id2:'line'})
	var x60=g1.line(70,260,734,260).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',opacity:.2,id2:'line'})
	var x80=g1.line(70,140,734,140).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',opacity:.2,id2:'line'})
	// var x100=g1.line(70,20,734,20).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',opacity:.2,id2:'line'})

	var x20=g1.line(70,500,80,500).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base'})
	var x40=g1.line(70,380,80,380).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base'})
	var x60=g1.line(70,260,80,260).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base'})
	var x80=g1.line(70,140,80,140).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base'})
	var x100=g1.line(70,20,80,20).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base'})

	var xaxisl=g1.text(65,620,'0%').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'18px',id:'base'})
	var x20l=g1.text(65,500,'20%').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'18px',id:'base'})
	var x40l=g1.text(65,380,'40%').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'18px',id:'base'})
	var x60l=g1.text(65,260,'60%').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'18px',id:'base'})
	var x80l=g1.text(65,140,'80%').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'18px',id:'base'})
	var x100l=g1.text(65,20,'100%').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'18px',id:'base'})

	var yaxis=g1.line(80,19.5,80,620).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',id2:'line'})
	var top=g1.line(80,20,734,20).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',id2:'line'})
	var right=g1.line(734,20,734,620).attr({stroke:'black','stroke-width':1,'shape-rendering':'crispEdges',id:'base',id2:'line'})
}

function basekey_g1(){
	var ft=g1.rect(80,-45,20,10).attr({fill:color_scale[0],'shape-rendering':'crispEdges',cursor:'pointer'})
	var pt=g1.rect(243.5,-45,20,10).attr({fill:color_scale[1],'shape-rendering':'crispEdges',cursor:'pointer'})
	var unemp=g1.rect(407,-45,20,10).attr({fill:color_scale[2],'shape-rendering':'crispEdges',cursor:'pointer'})
	var disabled=g1.rect(570.5,-45,20,10).attr({fill:color_scale[3],'shape-rendering':'crispEdges',cursor:'pointer'})
	var carer=g1.rect(80,-25,20,10).attr({fill:color_scale[4],'shape-rendering':'crispEdges',cursor:'pointer'})
	var retired=g1.rect(243.5,-25,20,10).attr({fill:color_scale[5],'shape-rendering':'crispEdges',cursor:'pointer'})
	var student=g1.rect(407,-25,20,10).attr({fill:color_scale[6],'shape-rendering':'crispEdges',cursor:'pointer'})
	var other=g1.rect(570.5,-25,20,10).attr({fill:color_scale[7],'shape-rendering':'crispEdges',cursor:'pointer'})

	var fttext=g1.text(105,-40,'Full-time employed').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})
	var fttext=g1.text(268.5,-40,'Part-time employed').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})
	var fttext=g1.text(432,-40,'Unemployed').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})
	var fttext=g1.text(595,-40,'Retired').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})
	var fttext=g1.text(105,-20,'Disabled').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})
	var fttext=g1.text(268.5,-20,'Carer').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})
	var fttext=g1.text(432,-20,'Student').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})
	var fttext=g1.text(595,-20,'Other').attr({'font-family':'Lato','text-anchor':'start','dominant-baseline':'central','font-size':'14px'})

	// # Bruenig
	// 	# 0 Full-time: PEMLR == 1 or PEMLR == 2 and PEHRUSLT > 34 or PEHRFTPT == 1
	// 	# 1 Part-time: PEMLR == 1 or PEMLR == 2 and PEHRUSLT < 35 and PEHRFTPT != 1
	// 	# 2 Unemployed: PEMLR == 3 or PEMLR == 4
	// 	# 3 Retired: PEMLR == 5 or (PEMLR == 7 and PENLFACT == 5)
	// 	# 4 Disabled: PEMLR == 6 or (PEMLR == 7 and PENLFACT == 1) or (PEMLR == 7 and PENLFACT == 2)
	// 	# 5 Carer: (PEMLR == 7 and PENLFACT == 4)
	// 	# 6 Student: (PEMLR == 7 and PENLFACT == 3)
	// 	# 7 Other: (PEMLR == 7 and PENLFACT = 6) or (PEMLR == 7 and PENLFACT == -1)
}

function year_slider(){
	// set up basic slider elements
	var slider_label1=g1.text(54,717,'GDP').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'14px'})
	var slider_label2=g1.text(54,731,'growth').attr({'font-family':'Lato','text-anchor':'end','dominant-baseline':'central','font-size':'14px'})
	var slider_box=g1.rect(60,710,650,30).attr({fill:'none','stroke-width':1,'stroke':'#cccccc','shape-rendering':'crispEdges'})
	var selected_width=650/(main.length/61)
	playbutton=g1.path('M726,718L734,725L726,732,L726,718').attr({'stroke-width':1,stroke:'#cccccc',fill:'none'})
	stopbutton=g1.rect(723,720,10,10).attr({'stroke-width':1,stroke:'#cccccc',fill:'none',opacity:0})
	var controlbutton=g1.circle(728,725,12).attr({fill:'#ddd',stroke:'#cccccc','stroke-width':1,'fill-opacity':0,cursor:'pointer'})
	controlbutton.click(playredraw)
	controlbutton.hover(function(){this.attr({'fill-opacity':.3})},function(){this.attr({'fill-opacity':0})})

	var moveFuncfloat=function(dx,dy,posx,posy){
		if(gplaying==0){
			coords=this.getBBox()

			if(coords.x-prevx+dx<60){
				newx=60
			} else if (coords.x-prevx+dx>710-coords.width){
				newx=710-coords.width
			} else {
				newx=coords.x-prevx+dx
			}
			snap=newx
			this.attr({x:snap})
			g1.selectAll("text[ident='slidetext']").attr({x:snap+(coords.width/2)})
			current_year=g1.select("text[ident='slidetext']").attr('text')
			year=Math.ceil(((snap-60)/coords.width)+min_year)
			if(startmonth!=1){
				g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(year-1)+'-',endmonth+'/'+year]})
			} else{
				g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(year)+'-',endmonth+'/'+year]})
			}
			g1.select("text[ident='slidetext']").selectAll("tspan:not(:first-child)").attr({x:g1.select("text[ident='slidetext']").attr('x'),dy:12})
			prevx=dx
		}
	}

	readcsv('gdp.csv',1,function(final){
	// retrieve recessions and shade GDP growth graph appropriately
		readcsv('recessions.csv',1,function(rec){
			var start=min_year+(startmonth-1)/12
			var end=max_year+(endmonth-1)/12
			var range=end-start
			rec_portion=650-650*((end-rec[rec.length-1][0])/range)
			// period_width=670/final.length
			for(var i=0;i<rec.length;i++){
				x_coord=60+((rec[i][0]-start)/range)*650
				if(x_coord>=60){
					var rec_rect=g1.rect(x_coord,710,rec_portion/rec.length,30).attr({fill:'#dddddd',opacity:rec[i][1],'stroke-width':0,'shape-rendering':'crispEdges'})
				}
			}
			gdp_portion=650-650*((end-final[final.length-1][0])/range)
			// retrieve gdp growth and draw the spark line for GDP growth
			var min_gdp=0
			var max_gdp=0
			for(var i=0;i<final.length;i++){
				if (final[i][1]<min_gdp){min_gdp=final[i][1]}
				if (final[i][1]>max_gdp){max_gdp=final[i][1]}
			}

			var zero_value=740-((-min_gdp)/(max_gdp-min_gdp))*30
			var zero=g1.line(60,zero_value,710,zero_value).attr({'stroke-width':1,'stroke':'#cccccc'})

			var data=final[0][1]
			var prev_value=740-((data-min_gdp)/(max_gdp-min_gdp))*30
			for(var i=1;i<final.length;i++){
				var data=final[i][1]
				var data_value=740-((data-min_gdp)/(max_gdp-min_gdp))*30

				var start=min_year+(startmonth-1)/12
				var end=max_year+(endmonth-1)/12
				var range=end-start
				var x_value=60+((final[i-1][0]-start)/range)*gdp_portion

				if(x_value>=60 & x_value<=710){
					var seg=g1.line(x_value,prev_value,x_value+(gdp_portion/final.length),data_value).attr({'stroke-width':1,'stroke':color_scale[0]})
				}

				var prev_value=data_value
			}

			// draw the red lines to indicate changes to the CPS
			var x_value=60+((1994-start)/range)*gdp_portion
			var red1=g1.line(x_value,710,x_value,740).attr({'stroke-width':1,'stroke':'red'})
			// red1.hover(tooltip1on,tooltip1off)
			var x_value=60+((1989-start)/range)*gdp_portion
			var red2=g1.line(x_value,710,x_value,740).attr({'stroke-width':1,'stroke':'red'})
			// red2.hover(tooltip2on,tooltip2off)
			
			// draw the slider in here so that it draws after all the recession blocks
			selected=g1.rect(710-selected_width,705,selected_width,40).attr({fill:'#333333','stroke-width':1,'stroke':'black','shape-rendering':'crispEdges','fill-opacity':.1,cursor:'move'})
			var shade=g1.rect(304,748,47,14).attr({fill:'#ddd'})
			var slider_label2=g1.text(385,760,['slide to pick a year (recessions are shaded, ','red lines',' indicate a major change to the CPS survey)']).attr({'font-family':'Lato','text-anchor':'middle','font-size':'14px'})
			slider_label2.selectAll("tspan")[1].attr({fill:'red'})
			var yearlabel=g1.text(710-selected_width+(selected_width/2),690,[main[0][4].split('-')[0]+'-',main[0][4].split('-')[1]]).attr({'font-family':'Lato','text-anchor':'middle','font-size':'12px','font-weight':700,ident:'slidetext'})
			yearlabel.selectAll("tspan:not(:first-child)").attr({x:yearlabel.attr('x'),dy:1*parseFloat(yearlabel.attr('font-size'))})
			selected.drag(moveFuncfloat,function(){x=this.attr('x');y=this.attr('y');prevx=0;prevy=0},function(){
				if(gplaying==0){
					breaks=[60]
					for(var i=0;i<main.length/61;i++){
						breaks.push(breaks[breaks.length-1]+selected_width)
					}

					snap=closest(breaks,newx)
					this.animate({x:snap},50)

					current_year=g1.select("text[ident='slidetext']").attr('text')
					year=Math.ceil(((snap-60)/coords.width)+min_year)
					if(startmonth!=1){
						g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(year-1)+'-',endmonth+'/'+year]})
					} else{
						g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(year)+'-',endmonth+'/'+year]})
					}
					g1.select("text[ident='slidetext']").selectAll("tspan:not(:first-child)").attr({x:snap+(coords.width/2),dy:12})
					g1.selectAll("text[ident='slidetext']").attr({x:snap+(coords.width/2)})
					if(year!=current_slide_year){current_slide_year=year;redraw_g1(year,0,gmin,gmax)}
				}
			})
		})
	})
}

function tooltip1on(e){
	console.log(e.clientX,e.clientY)
	g1.rect(e.clientX+3,e.clientY-200,120,80,3,3).attr({fill:'black',opacity:.5,type:'tooltip'})
	// "In 1994, the CPS survey underwent a number of alterations. One of these alterations changed how respondents designate themselves as either retired or carers/home-makers. Consequently, many respondents who we would usually consider retired instead classified themselves as carers."

}

function tooltip1off(){
	g1.selectAll()
}

function tooltip2on(){
	// "Prior to 1989, it was not possible for respondents to choose 'retired' as an option. Instead, the 'other' option was designated 'other (including retired).' Consequently, if you look at the area chart prior to this date, you will see that 'other' percentages are high for those over 50."
}

function tooltip2off(){

}

function playredraw(){
	if(gplaying==0){
		gplaying=1
		playbutton.attr({opacity:0})
		stopbutton.attr({opacity:1})
		running=setInterval(function(){
			if(current_slide_year==max_year){
				selected.attr({x:60})
				coords=selected.getBBox()
				a=g1.select("text[ident='slidetext']").attr({x:60+(coords.width/2)})
				a.selectAll('tspan').attr({x:60+(coords.width/2)},300)
				current_slide_year=min_year

				if(startmonth!=1){
					g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(current_slide_year-1)+'-',endmonth+'/'+current_slide_year]})
				} else{
					g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(current_slide_year)+'-',endmonth+'/'+current_slide_year]})
				}
				g1.select("text[ident='slidetext']").selectAll("tspan:not(:first-child)").attr({x:g1.select("text[ident='slidetext']").attr('x'),dy:12})

			} else{
				selected.animate({x:parseFloat(selected.attr('x'))+parseFloat(selected.attr('width'))},300)
				a=g1.select("text[ident='slidetext']").animate({x:parseFloat(selected.attr('x'))+parseFloat(selected.attr('width'))+(coords.width/2)},300)
				a.selectAll('tspan').animate({x:parseFloat(selected.attr('x'))+parseFloat(selected.attr('width'))+(coords.width/2),dy:12},300)
				// g1.select("text[ident='slidetext']").selectAll("tspan:not(:first-child)").attr({x:g1.select("text[ident='slidetext']").attr('x'),dy:12})
				current_slide_year=current_slide_year+1

				if(startmonth!=1){
					g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(current_slide_year-1)+'-',endmonth+'/'+current_slide_year]})
				} else{
					g1.select("text[ident='slidetext']").attr({text:[startmonth+'/'+(current_slide_year)+'-',endmonth+'/'+current_slide_year]})
				}
				g1.select("text[ident='slidetext']").selectAll("tspan:not(:first-child)").attr({dx:-47,dy:12})

			}
			redraw_g1(current_slide_year,0,gmin,gmax)
		}, 700)
	} else{
		clearInterval(running)
		playbutton.attr({opacity:1})
		stopbutton.attr({opacity:0})
		gplaying=0
	}
}

function redraw_g1(year,newdraw,min,max){
	if(newdraw==1){
		g1.selectAll('path[id2="area"]').remove()
		gmin=min
		gmax=max
	}
	var data=[]
	for(i=0;i<main.length;i++){
		if(main[i][1]==year){
			data.push(main[i])
		}
	}

	// loop through variables b0-b7
	var base=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
	var positions=[80]
	for(var i=0;i<60;i++){
		positions.push(80+(i+1)*(654/60))
	}

	for(var i=5;i<13;i++){
		if(i<min | i+1>max){
			try{
				g1.select("path[id='area"+i+"']").remove()
			} catch(err){}
		}
	}

	for(var i=min;i<max;i++){
		path='M'+positions[0]+' '+get_value(base[0])
		new_positions=[]

		// the base path is the bottom of the area
		for(var j=1;j<61;j++){
			path=path+'L'+positions[j]+' '+get_value(base[j])
		}

		// now move up to the top path, which will become the new base path
		newbase=[]
		dvalue=data[data.length-1][i]
		dvalue=get_value(parseFloat(dvalue)+parseFloat(base[base.length-1]))
		path=path+'L'+positions[positions.length-1]+' '+dvalue

		for(var j=60;j>=0;j--){
			path=path+'L'+positions[j]+' '+get_value(data[j][i]+base[j])
			newbase.unshift(data[j][i]+base[j])
		}

		// now draw back down to the base
		path=path+'L'+positions[0]+' '+get_value(base[0])

		if(newdraw==1){
			// var area=g1.path('M80 620L80 620L90.9 620L101.8 620L112.7 620L123.6 620L134.5 620L145.4 620L156.3 620L167.2 620L178.1 620L189.0 620L199.9 620L210.8 620L221.7 620L232.6 620L243.5 620L254.4 620L265.3 620L276.2 620L287.1 620L298.0 620L308.9 620L319.8 620L330.7 620L341.6 620L352.5 620L363.4 620L374.3 620L385.2 620L396.1 620L407.0 620L417.9 620L428.8 620L439.7 620L450.6 620L461.5 620L472.4 620L483.3 620L494.2 620L505.1 620L516.0 620L526.9 620L537.8 620L548.7 620L559.6 620L570.5 620L581.4 620L592.3 620L603.2 620L614.1 620L625.0 620L635.9 620L646.8 620L657.7 620L668.6 620L679.5 620L690.4 620L701.3 620L712.2 620L723.1 620L734.0 620L734 619L734.0 619L723.1 619L712.2 619L701.3 619L690.4 619L679.5 619L668.6 619L657.7 619L646.8 619L635.9 619L625.0 619L614.1 619L603.2 619L592.3 619L581.4 619L570.5 619L559.6 619L548.7 619L537.8 619L526.9 619L516.0 619L505.1 619L494.2 619L483.3 619L472.4 619L461.5 619L450.6 619L439.7 619L428.8 619L417.9 619L407.0 619L396.1 619L385.2 619L374.3 619L363.4 619L352.5 619L341.6 619L330.7 619L319.8 619L308.9 619L298.0 619L287.1 619L276.2 619L265.3 619L254.4 619L243.5 619L232.6 619L221.7 619L210.8 619L199.9 619L189.0 619L178.1 619L167.2 619L156.3 619L145.4 619L134.5 619L123.6 619L112.7 619L101.8 619L90.9 619L80 619').attr({fill:color_scale[i-5],id:'area'+i})
			var area=g1.path(path).attr({fill:color_scale[i-5],id:'area'+i,id2:'area',cursor:'pointer'})
			// area.animate({path:path},500)
		} else{
			var area=g1.select("path[id='area"+i+"']").animate({path:path},500)
		}
		area.hover(highlight_area,unhighlight_area)
		try{area.unclick(clickredraw)}catch(err){}
		area.click(clickredraw)
		base=newbase

	}

	function get_value(y){
		return 620-y*600
	}

	base_g1()
}

function clickredraw(ev){
	if(gclicked==0){
		item=Snap(ev.target)
		type=item.attr('id')
		type=type.slice(4,type.length)
		gmin=parseInt(type)
		gmax=parseInt(type)+1
		gclicked=1
		redraw_g1(current_slide_year,0,parseInt(type),parseInt(type)+1)
	} else if(gclicked==1){
		gclicked=0
		redraw_g1(current_slide_year,1,5,13)
	}
}

function highlight_area(ev){
	item=Snap(ev.target)
	g1.append(item)
	// var f = g1.filter(Snap.filter.shadow(0, 0, 6))
	a=g1.selectAll('[id2="line"]')
	for(var i=0;i<a.length;i++){
		g1.append(a[i])
	}
	// item.attr({filter:f})
	// areas=g1.selectAll("path[id2='area']")
	// for(var i=0;i<areas.length;i++){
	// 	if(areas[i]!=item){
	// 		areas[i].attr({opacity:.6})
	// 	}
	// }
	item.attr({'fill-opacity':.7})
	item.attr({'stroke':item.attr('fill'),'stroke-width':1})
}

function unhighlight_area(ev){
	item=Snap(ev.target)
	// item.attr({filter:''})
	// areas=g1.selectAll("path[id2='area']").attr({opacity:1})
	item.attr({'fill-opacity':1})
	item.attr({'stroke-width':0})
}

function readcsv(file,dateflag,callback) {
	var rawFile = new XMLHttpRequest();
	rawFile.open("GET", file);
	rawFile.onreadystatechange = function () {
		if(rawFile.readyState === 4) {
			if(rawFile.status === 200 || rawFile.status == 0) {
				var text = rawFile.responseText;
				text=text.split('\n')
				for(var i=0;i<text.length;i++){
					text[i]=text[i].split(',')
				}
				var final=[]

				// return years only
				if(dateflag==0){
					for(var i=1;i<text.length;i++){
						final.push([parseInt(text[i][0].split('-')[0]),parseFloat(text[i][1])])
					}
				}

				// convert months to fractions and return years+(months-1)/12
				if(dateflag==1){
					for(var i=1;i<text.length;i++){
						final.push([parseFloat(text[i][0].split('-')[0])+(parseFloat(text[i][0].split('-')[1])-1)/12,parseFloat(text[i][1])])
					}
				}
				callback(final)
			}
		}
	}
	rawFile.send(null);
}

function loadmain(file,callback){
	var rawFile = new XMLHttpRequest();
	rawFile.open("GET", file);
	rawFile.onreadystatechange = function () {
		if(rawFile.readyState === 4) {
			if(rawFile.status === 200 || rawFile.status == 0) {
				var text = rawFile.responseText;
				text=text.split('\n')

				for(var i=0;i<text.length;i++){
					text[i]=text[i].split(',')
				}

				main=[]
				for(var i=1;i<text.length;i++){
					main.push([parseInt(text[i][0]),parseInt(text[i][1]),parseInt(text[i][2]),parseInt(text[i][3]),text[i][4],parseFloat(text[i][5]),parseFloat(text[i][6]),parseFloat(text[i][7]),parseFloat(text[i][8]),parseFloat(text[i][9]),parseFloat(text[i][10]),parseFloat(text[i][11]),parseFloat(text[i][12])])
				}

				callback(main)
			}
		}
	}
	rawFile.send(null);
}

// from stackoverflow - Umesh Patil: http://stackoverflow.com/a/8585063
function closest(array,num){
    var i=0;
    var minDiff=1000;
    var ans;
    for(i in array){
         var m=Math.abs(num-array[i]);
         if(m<minDiff){ 
                minDiff=m; 
                ans=array[i]; 
            }
      }
    return ans;
}

</script>

</html>